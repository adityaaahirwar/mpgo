rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user is signed in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user matches the document ID
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Fetch the user's role from the 'users' collection
    // Note: In high-scale apps, Custom Claims are preferred, but Firestore lookup works for this architecture.
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getRole() == 'admin';
    }

    // Ensure the user is not trying to modify restricted fields (like 'role')
    function notUpdatingRole() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
    }

    // --- COLLECTION RULES ---

    // 1. USERS
    match /users/{userId} {
      // Admin can read all users (for management). Owners can read their own profile.
      allow read: if isOwner(userId) || isAdmin();
      
      // CREATE: User can create their own profile on signup. 
      // They cannot set themselves as admin via client (enforced by validation or Cloud Functions usually),
      // but here we allow initial creation.
      allow create: if isOwner(userId);

      // UPDATE: Owner can update details (name, email) but NOT their role.
      // Admin can update anything.
      allow update: if (isOwner(userId) && notUpdatingRole()) || isAdmin();
    }

    // 2. JOBS
    match /jobs/{jobId} {
      // Public access: Anyone can read jobs
      allow read: if true;

      // Admin access: Only admins can create, update, or delete
      allow write: if isAdmin();
    }

    // 3. APPLICATIONS
    match /applications/{applicationId} {
      // READ: Admin sees all. User sees only their own.
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);

      // CREATE: Users can apply. Must tag with their own userId. Initial status must be 'Pending'.
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.status == 'Pending';

      // UPDATE: 
      // Admin can change status.
      // User CANNOT update their application (e.g. they can't mark themselves as 'Hired').
      allow update: if isAdmin();
      
      // DELETE: Only admin can delete applications.
      allow delete: if isAdmin();
    }

    // 4. AUDIT LOGS
    match /auditLogs/{logId} {
      // Only Admin can read logs
      allow read: if isAdmin();

      // Only Admin can create logs. 
      // Logs are append-only (no update/delete).
      allow create: if isAdmin();
      allow update, delete: if false;
    }
  }
}